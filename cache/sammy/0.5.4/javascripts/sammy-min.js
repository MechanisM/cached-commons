(function(e){var k,d="([^/]+)",g=/:([\w\d]+)/g,h=/\?([^#]*)$/,a=function(l){return Array.prototype.slice.call(l)},b=function(l){return Object.prototype.toString.call(l)==="[object Function]"},i=function(l){return Object.prototype.toString.call(l)==="[object Array]"},f=decodeURIComponent,j=function(l){return function(m,n){return this.route.apply(this,[l,m,n])}},c=[];k=function(){var m=a(arguments),n,l;k.apps=k.apps||{};if(m.length===0||m[0]&&b(m[0])){return k.apply(k,["body"].concat(m))}else{if(typeof(l=m.shift())=="string"){n=k.apps[l]||new k.Application();n.element_selector=l;if(m.length>0){e.each(m,function(o,p){n.use(p)})}if(n.element_selector!=l){delete k.apps[l]}k.apps[n.element_selector]=n;return n}}};k.VERSION="0.5.4";k.addLogger=function(l){c.push(l)};k.log=function(){var l=a(arguments);l.unshift("["+Date()+"]");e.each(c,function(n,m){m.apply(k,l)})};if(typeof window.console!="undefined"){if(b(console.log.apply)){k.addLogger(function(){window.console.log.apply(console,arguments)})}else{k.addLogger(function(){window.console.log(arguments)})}}else{if(typeof console!="undefined"){k.addLogger(function(){console.log.apply(console,arguments)})}}e.extend(k,{makeArray:a,isFunction:b,isArray:i});k.Object=function(l){return e.extend(this,l||{})};e.extend(k.Object.prototype,{toHash:function(){var l={};e.each(this,function(n,m){if(!b(m)){l[n]=m}});return l},toHTML:function(){var l="";e.each(this,function(n,m){if(!b(m)){l+="<strong>"+n+"</strong> "+m+"<br />"}});return l},keys:function(l){var m=[];for(var n in this){if(!b(this[n])||!l){m.push(n)}}return m},has:function(l){return this[l]&&e.trim(this[l].toString())!=""},join:function(){var m=a(arguments);var l=m.shift();return m.join(l)},log:function(){k.log.apply(k,arguments)},toString:function(l){var m=[];e.each(this,function(o,n){if(!b(n)||l){m.push('"'+o+'": '+n.toString())}});return"Sammy.Object: {"+m.join(",")+"}"}});k.HashLocationProxy=function(m,l){this.app=m;this.is_native=false;this._startPolling(l)};k.HashLocationProxy.prototype={bind:function(){var l=this,m=this.app;e(window).bind("hashchange."+this.app.eventNamespace(),function(o,n){if(l.is_native===false&&!n){k.log("native hash change exists, using");l.is_native=true;clearInterval(k.HashLocationProxy._interval)}m.trigger("location-changed")})},unbind:function(){e(window).unbind("hashchange."+this.app.eventNamespace())},getLocation:function(){var l=window.location.toString().match(/^[^#]*(#.+)$/);return l?l[1]:""},setLocation:function(l){return(window.location=l)},_startPolling:function(n){var m=this;if(!k.HashLocationProxy._interval){if(!n){n=10}var l=function(){current_location=m.getLocation();if(!k.HashLocationProxy._last_location||current_location!=k.HashLocationProxy._last_location){setTimeout(function(){e(window).trigger("hashchange",[true])},1)}k.HashLocationProxy._last_location=current_location};l();k.HashLocationProxy._interval=setInterval(l,n);e(window).bind("beforeunload",function(){clearInterval(k.HashLocationProxy._interval)})}}};k.Application=function(l){var m=this;this.routes={};this.listeners=new k.Object({});this.arounds=[];this.befores=[];this.namespace=(new Date()).getTime()+"-"+parseInt(Math.random()*1000,10);this.context_prototype=function(){k.EventContext.apply(this,arguments)};this.context_prototype.prototype=new k.EventContext();if(b(l)){l.apply(this,[this])}if(!this.location_proxy){this.location_proxy=new k.HashLocationProxy(m,this.run_interval_every)}if(this.debug){this.bindToAllEvents(function(o,n){m.log(m.toString(),o.cleaned_type,n||{})})}};k.Application.prototype=e.extend({},k.Object.prototype,{ROUTE_VERBS:["get","post","put","delete"],APP_EVENTS:["run","unload","lookup-route","run-route","route-found","event-context-before","event-context-after","changed","error","check-form-submission","redirect"],_last_route:null,_running:false,element_selector:"body",debug:false,raise_errors:false,run_interval_every:50,location_proxy:null,template_engine:null,toString:function(){return"Sammy.Application:"+this.element_selector},$element:function(){return e(this.element_selector)},use:function(){var l=a(arguments);var m=l.shift();try{l.unshift(this);m.apply(this,l)}catch(n){if(typeof m=="undefined"){this.error("Plugin Error: called use() but plugin is not defined",n)}else{if(!b(m)){this.error("Plugin Error: called use() but '"+m.toString()+"' is not a function",n)}else{this.error("Plugin Error",n)}}}return this},route:function(o,m,q){var n=this,p=[],l;if(!q&&b(m)){m=o;q=m;o="any"}o=o.toLowerCase();if(m.constructor==String){g.lastIndex=0;while((path_match=g.exec(m))!==null){p.push(path_match[1])}m=new RegExp("^"+m.replace(g,d)+"$")}if(typeof q=="string"){q=n[q]}l=function(s){var t={verb:s,path:m,callback:q,param_names:p};n.routes[s]=n.routes[s]||[];n.routes[s].push(t)};if(o==="any"){e.each(this.ROUTE_VERBS,function(s,r){l(r)})}else{l(o)}return this},get:j("get"),post:j("post"),put:j("put"),del:j("delete"),any:j("any"),mapRoutes:function(m){var l=this;e.each(m,function(n,o){l.route.apply(l,o)});return this},eventNamespace:function(){return["sammy-app",this.namespace].join("-")},bind:function(l,n,p){var o=this;if(typeof p=="undefined"){p=n}var m=function(){var s,q,r;s=arguments[0];r=arguments[1];if(r&&r.context){q=r.context;delete r.context}else{q=new o.context_prototype(o,"bind",s.type,r,s.target)}s.cleaned_type=s.type.replace(o.eventNamespace(),"");p.apply(q,[s,r])};if(!this.listeners[l]){this.listeners[l]=[]}this.listeners[l].push(m);if(this.isRunning()){this._listen(l,m)}return this},trigger:function(l,m){this.$element().trigger([l,this.eventNamespace()].join("."),[m]);return this},refresh:function(){this.last_location=null;this.trigger("location-changed");return this},before:function(l,m){if(b(l)){m=l;l={}}this.befores.push([l,m]);return this},after:function(l){return this.bind("event-context-after",l)},around:function(l){this.arounds.push(l);return this},isRunning:function(){return this._running},helpers:function(l){e.extend(this.context_prototype.prototype,l);return this},helper:function(l,m){this.context_prototype.prototype[l]=m;return this},run:function(l){if(this.isRunning()){return false}var m=this;e.each(this.listeners.toHash(),function(n,o){e.each(o,function(q,p){m._listen(n,p)})});this.trigger("run",{start_url:l});this._running=true;this.last_location=null;if(this.getLocation()==""&&typeof l!="undefined"){this.setLocation(l)}this._checkLocation();this.location_proxy.bind();this.bind("location-changed",function(){m._checkLocation()});this.bind("submit",function(o){var n=m._checkFormSubmission(e(o.target).closest("form"));return(n===false)?o.preventDefault():false});e(window).bind("beforeunload",function(){m.unload()});return this.trigger("changed")},unload:function(){if(!this.isRunning()){return false}var l=this;this.trigger("unload");this.location_proxy.unbind();this.$element().unbind("submit").removeClass(l.eventNamespace());e.each(this.listeners.toHash(),function(m,n){e.each(n,function(p,o){l._unlisten(m,o)})});this._running=false;return this},bindToAllEvents:function(m){var l=this;e.each(this.APP_EVENTS,function(n,o){l.bind(o,m)});e.each(this.listeners.keys(true),function(o,n){if(l.APP_EVENTS.indexOf(n)==-1){l.bind(n,m)}});return this},routablePath:function(l){return l.replace(h,"")},lookupRoute:function(o,m){var n=this,l=false;this.trigger("lookup-route",{verb:o,path:m});if(typeof this.routes[o]!="undefined"){e.each(this.routes[o],function(q,p){if(n.routablePath(m).match(p.path)){l=p;return false}})}return l},runRoute:function(n,z,p,s){var o=this,x=this.lookupRoute(n,z),m,v,q,u,y,w,t,l;this.log("runRoute",[n,z].join(" "));this.trigger("run-route",{verb:n,path:z,params:p});if(typeof p=="undefined"){p={}}e.extend(p,this._parseQueryString(z));if(x){this.trigger("route-found",{route:x});if((path_params=x.path.exec(this.routablePath(z)))!==null){path_params.shift();e.each(path_params,function(A,B){if(x.param_names[A]){p[x.param_names[A]]=f(B)}else{if(!p.splat){p.splat=[]}p.splat.push(f(B))}})}m=new this.context_prototype(this,n,z,p,s);q=this.arounds.slice(0);y=this.befores.slice(0);t=[m].concat(p.splat);v=function(){var A;while(y.length>0){w=y.shift();if(o.contextMatchesOptions(m,w[0])){A=w[1].apply(m,[m]);if(A===false){return false}}}o.last_route=x;m.trigger("event-context-before",{context:m});A=x.callback.apply(m,t);m.trigger("event-context-after",{context:m});return A};e.each(q.reverse(),function(A,B){var C=v;v=function(){return B.apply(m,[C])}});try{l=v()}catch(r){this.error(["500 Error",n,z].join(" "),r)}return l}else{return this.notFound(n,z)}},contextMatchesOptions:function(o,q,m){var n=q;if(typeof n==="undefined"||n=={}){return true}if(typeof m==="undefined"){m=true}if(typeof n==="string"||b(n.test)){n={path:n}}if(n.only){return this.contextMatchesOptions(o,n.only,true)}else{if(n.except){return this.contextMatchesOptions(o,n.except,false)}}var l=true,p=true;if(n.path){if(b(n.path.test)){l=n.path.test(o.path)}else{l=(n.path.toString()===o.path)}}if(n.verb){p=n.verb===o.verb}return m?(p&&l):!(p&&l)},getLocation:function(){return this.location_proxy.getLocation()},setLocation:function(l){return this.location_proxy.setLocation(l)},swap:function(l){return this.$element().html(l)},notFound:function(n,m){var l=this.error(["404 Not Found",n,m].join(" "));return(n==="get")?l:true},error:function(m,l){if(!l){l=new Error()}l.message=[m,l.message].join(" ");this.trigger("error",{message:l.message,error:l});if(this.raise_errors){throw (l)}else{this.log(l.message,l)}},_checkLocation:function(){var l,m;l=this.getLocation();if(l!=this.last_location){this.last_location=l;m=this.runRoute("get",l)}return m},_checkFormSubmission:function(n){var l,o,q,p,m;this.trigger("check-form-submission",{form:n});l=e(n);o=l.attr("action");q=e.trim(l.attr("method").toString().toLowerCase());if(!q||q==""){q="get"}this.log("_checkFormSubmission",l,o,q);if(q==="get"){this.setLocation(o+"?"+l.serialize());m=false}else{p=e.extend({},this._parseFormParams(l));m=this.runRoute(q,o,p,n.get(0))}return(typeof m=="undefined")?false:m},_parseFormParams:function(l){var o={},n=l.serializeArray(),m;for(m=0;m<n.length;m++){o=this._parseParamPair(o,n[m].name,n[m].value)}return o},_parseQueryString:function(o){var q={},n,m,p,l;n=o.match(h);if(n){m=n[1].split("&");for(l=0;l<m.length;l++){p=m[l].split("=");q=this._parseParamPair(q,f(p[0]),f(p[1]))}}return q},_parseParamPair:function(n,l,m){if(n[l]){if(i(n[l])){n[l].push(m)}else{n[l]=[n[l],m]}}else{n[l]=m}return n},_listen:function(l,m){return this.$element().bind([l,this.eventNamespace()].join("."),m)},_unlisten:function(l,m){return this.$element().unbind([l,this.eventNamespace()].join("."),m)}});k.EventContext=function(p,o,m,n,l){this.app=p;this.verb=o;this.path=m;this.params=new k.Object(n);this.target=l};k.EventContext.prototype=e.extend({},k.Object.prototype,{$element:function(){return this.app.$element()},partial:function(t,p,s){var l,o,r,q,n="partial:"+t,m=this;if((r=t.match(/\.([^\.]+)$/))){r=r[1]}if((!r||!b(m[r]))&&this.app.template_engine){r=this.app.template_engine}if(r&&!b(r)&&b(m[r])){r=m[r]}if(!s&&b(p)){s=p;p={}}q=(i(p)?p:[p||{}]);o=function(u){var v=u,w="";e.each(q,function(x,y){if(b(r)){v=r.apply(m,[u,y])}w+=v;if(s){return s.apply(m,[v,x])}});if(!s){m.swap(w)}m.trigger("changed")};if(this.app.cache_partials&&this.cache(n)){o.apply(m,[this.cache(n)])}else{e.get(t,function(u){if(m.app.cache_partials){m.cache(n,u)}o.apply(m,[u])})}},redirect:function(){var n,m=a(arguments),l=this.app.getLocation();if(m.length>1){m.unshift("/");n=this.join.apply(this,m)}else{n=m[0]}this.trigger("redirect",{to:n});this.app.last_location=this.path;this.app.setLocation(n);if(l==n){this.app.trigger("location-changed")}},trigger:function(l,m){if(typeof m=="undefined"){m={}}if(!m.context){m.context=this}return this.app.trigger(l,m)},eventNamespace:function(){return this.app.eventNamespace()},swap:function(l){return this.app.swap(l)},notFound:function(){return this.app.notFound(this.verb,this.path)},toString:function(){return"Sammy.EventContext: "+[this.verb,this.path,this.params].join(" ")}});e.sammy=window.Sammy=k})(jQuery);
